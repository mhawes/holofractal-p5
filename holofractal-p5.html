<!DOCTYPE html>
<style>
    #controls-toggle {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: #222;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 15px;
    }
    #controls-panel {
        position: absolute;
        top: 48px;
        left: 10px;
        z-index: 10;
        background: rgba(30,30,30,0.95);
        color: #fff;
        padding: 16px 18px 12px 18px;
        border-radius: 8px;
        box-shadow: 0 2px 12px #0006;
        min-width: 220px;
        display: none;
    }
    #controls-panel label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
    }
    #controls-panel input[type=range] {
        width: 100%;
        margin-bottom: 16px;
    }
</style>
<button id="controls-toggle">Show Controls</button>
<div id="controls-panel">
    <label>
        Circle Distance (r):
        <input type="range" id="slider-r" min="10" max="100" value="34">
    </label>
    <label>
        Circle Stroke Weight:
        <input type="range" id="slider-stroke" min="0.1" max="10" step="0.1" value="0.5">
    </label>
    <label>
        Base Speed:
        <input type="range" id="slider-speed" min="0.1" max="10" step="0.01" value="0.5">
    </label>
    <label>
        Total Circle Count:
        <input type="range" id="slider-count" min="1" max="50" step="1" value="1">
    </label>
    <label>
        Max Diameter:
        <input type="range" id="slider-maxd" min="50" max="1200" step="1" value="800">
    </label>
    <label>
        Min Diameter:
        <input type="range" id="slider-mind" min="1" max="200" step="1" value="4">
    </label>
    <label>
        <input type="checkbox" id="toggle-pulse" checked>
        Show Pulsing Center Dots
    </label>
</div>

<script>
    // UI toggle logic
    const toggleBtn = document.getElementById('controls-toggle');
    const panel = document.getElementById('controls-panel');
    let panelVisible = false;
    toggleBtn.onclick = () => {
        panelVisible = !panelVisible;
        panel.style.display = panelVisible ? 'block' : 'none';
        toggleBtn.textContent = panelVisible ? 'Hide Controls' : 'Show Controls';
    };
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>p5.js App</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
</head>
<body>
    <script>
        // Default values
        window.simParams = {
            r: 34,
            strokeWeight: 0.5,
            baseSpeed: 0.5
        };

        // Get sliders
        const sliderR = document.getElementById('slider-r');
        const sliderStroke = document.getElementById('slider-stroke');
        const sliderSpeed = document.getElementById('slider-speed');
        const sliderCount = document.getElementById('slider-count');
        const sliderMaxD = document.getElementById('slider-maxd');
        const sliderMinD = document.getElementById('slider-mind');

        sliderCount.oninput = () => window.simParams.count = Number(sliderCount.value);
        sliderMaxD.oninput = () => window.simParams.maxD = Number(sliderMaxD.value);
        sliderMinD.oninput = () => window.simParams.minD = Number(sliderMinD.value);

        // Initialize with slider values
        window.simParams.count = Number(sliderCount.value);
        window.simParams.maxD = Number(sliderMaxD.value);
        window.simParams.minD = Number(sliderMinD.value);

        // Update simParams on slider input
        sliderR.oninput = () => window.simParams.r = Number(sliderR.value);
        sliderStroke.oninput = () => window.simParams.strokeWeight = Number(sliderStroke.value);
        sliderSpeed.oninput = () => window.simParams.baseSpeed = Number(sliderSpeed.value);

        // Initialize with slider values
        window.simParams.r = Number(sliderR.value);
        window.simParams.strokeWeight = Number(sliderStroke.value);
        window.simParams.baseSpeed = Number(sliderSpeed.value);

        // Add pulse toggle to simParams
        window.simParams.showPulse = true;
        const togglePulse = document.getElementById('toggle-pulse');
        togglePulse.oninput = () => window.simParams.showPulse = togglePulse.checked;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            background(220);
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            background(220);
        }

        
        // Set this variable externally to control the circle size (e.g., from an audio visualizer)
        window.externalCircleDiameter = window.externalCircleDiameter || null;

        function draw() {
            background(2, 2, 2, 10); // subtle dark background

            // Use simParams for all parameters
            const {
            r = 34,
            strokeWeight: sw = 0.5,
            baseSpeed = 0.5,
            count = 1,
            maxD = width,
            minD = 4
            } = window.simParams;

            // Circle "wave" system: circles shrink, then grow, with easing
            if (typeof window.circles === 'undefined') {
            window.circles = [];
            }

            // If external control, just draw one circle at that size everywhere
            if (window.externalCircleDiameter !== null) {
            window.circles = [{
                d: Math.max(minD, Math.min(maxD, window.externalCircleDiameter)),
                shrinking: true,
                waitTime: 0,
                waitUntil: 0
            }];
            } else {
            // Spawn circles if none exist or adjust count
            while (window.circles.length < count) {
                window.circles.push({
                d: maxD,
                shrinking: true,
                waitTime: 0,
                waitUntil: 0
                });
            }
            while (window.circles.length > count) {
                window.circles.pop();
            }
            // Animate each circle
            for (let i = 0; i < window.circles.length; i++) {
                let c = window.circles[i];
                // Easing: slow down as approaching minD, speed up as growing
                let t = (c.d - minD) / (maxD - minD); // 1 at maxD, 0 at minD
                let speed = baseSpeed * (c.shrinking ? (0.3 + 0.7 * t) : (0.3 + 0.7 * (1 - t)));

                // Wait logic
                if (c.waitUntil && millis() < c.waitUntil) {
                // Still waiting, do nothing
                } else {
                if (c.shrinking) {
                    c.d -= speed;
                    if (c.d <= minD + 0.1) {
                    c.d = minD;
                    c.shrinking = false;
                    // Set random wait time before growing again
                    c.waitTime = random(150, 600);
                    c.waitUntil = millis() + c.waitTime;
                    }
                } else {
                    c.d += speed;
                    if (c.d >= maxD - 0.1) {
                    c.d = maxD;
                    c.shrinking = true;
                    // Set random wait time before shrinking again
                    c.waitTime = random(150, 600);
                    c.waitUntil = millis() + c.waitTime;
                    }
                }
                // Clamp
                c.d = constrain(c.d, minD, maxD);
                }
            }
            }

            let cols = Math.ceil(width / (r * 1.5)) + 2;
            let rows = Math.ceil(height / (r * Math.sqrt(3))) + 2;

            // Center of canvas
            let cx = width / 2;
            let cy = height / 2;

            colorMode(HSB, 360, 100, 100, 255);
            noFill();
            strokeWeight(sw); // use simParams.strokeWeight

            // Always draw the grid so that one grid point is exactly at the center
            let centerCol = Math.floor(cols / 2);
            let centerRow = Math.floor(rows / 2);

            // Max distance is from center to farthest corner
            let maxDist = dist(0, 0, Math.max(cx, width - cx), Math.max(cy, height - cy));

            for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                // Hexagonal grid offset
                let x = cx + (col - centerCol) * r * 1.5;
                let y = cy + (row - centerRow) * r * Math.sqrt(3) + ((col % 2) * (r * Math.sqrt(3) / 2));

                // Distance from center
                let distToCenter = dist(x, y, cx, cy);

                let hue = map(distToCenter, 0, maxDist, 0, 360);

                // Alpha fades with distance: 255 at center, 40 at edge
                let alpha = map(distToCenter, 0, maxDist, 255, 40);
                alpha = constrain(alpha, 40, 255);

                // Center circle is fully opaque, others are semi-transparent but also fade with distance
                if (Math.abs(x - cx) < 1 && Math.abs(y - cy) < 1) {
                stroke(hue, 80, 100, 255);
                } else {
                stroke(hue, 80, 100, alpha);
                }

                // Draw all circles at this grid point
                for (let c of window.circles) {
                ellipse(x, y, c.d, c.d);
                }
            }
            }

            if (window.simParams.showPulse) {
                colorMode(RGB, 255, 255, 255, 255); // reset color mode

                // --- Pulsing dark dot in the center ---
                let pulse = 10 + 8 * sin(millis() * 0.005);
                noStroke();
                fill(50);
                ellipse(cx, cy, pulse, pulse);

                // --- Pulsing white dot in the center ---
                let pulse2 = 4 + 3 * sin(millis() * 0.02);
                noStroke();
                fill(255);
                ellipse(cx, cy, pulse2, pulse2);
            }
        }
    </script>
</body>
</html>
